name: Manual Sync Upstream

on:
  workflow_dispatch:
    inputs:
      sync_mode:
        description: 'åŒæ­¥æ¨¡å¼'
        required: true
        default: 'merge'
        type: choice
        options:
          - merge
          - reset
      backup_database:
        description: 'æ›´æ–°å‰å¤‡ä»½æ•°æ®åº“'
        required: true
        default: true
        type: boolean
      deploy_after_sync:
        description: 'åŒæ­¥åè‡ªåŠ¨éƒ¨ç½²'
        required: true
        default: true
        type: boolean

jobs:
  sync:
    name: Sync with Upstream
    runs-on: ubuntu-latest
    env:
      WRANGLER_VERSION: "4.54.0"
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/qaz741wsd856/warden-worker.git || true
          git fetch upstream

      - name: Check for updates
        id: check
        run: |
          LOCAL=$(git rev-parse main)
          REMOTE=$(git rev-parse upstream/main)
          
          if [ "$LOCAL" = "$REMOTE" ]; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "âœ… å·²ç»æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ å‘ç°ä¸Šæ¸¸æ›´æ–°"
            echo ""
            echo "å³å°†åˆå¹¶çš„æ›´æ–°:"
            git log --oneline main..upstream/main | head -20
          fi

      - name: Backup database (optional)
        if: inputs.backup_database && steps.check.outputs.has_updates == 'true'
        run: |
          echo "ğŸ’¾ æ­£åœ¨å¤‡ä»½æ•°æ®åº“..."
          BACKUP_FILE="backup-$(date +%Y%m%d-%H%M%S).sql"
          
          # å®‰è£… wrangler
          npm install -g wrangler@${WRANGLER_VERSION}
          
          # å¯¼å‡ºæ•°æ®åº“
          if wrangler d1 export vault1 --remote --output="$BACKUP_FILE"; then
            echo "âœ… æ•°æ®åº“å·²å¤‡ä»½: $BACKUP_FILE"
            
            # ä¸Šä¼ å¤‡ä»½ä½œä¸º artifact
            mkdir -p backups
            cp "$BACKUP_FILE" backups/
          else
            echo "âš ï¸ æ•°æ®åº“å¤‡ä»½å¤±è´¥ï¼Œç»§ç»­æ›´æ–°..."
          fi

      - name: Sync upstream (merge mode)
        if: inputs.sync_mode == 'merge' && steps.check.outputs.has_updates == 'true'
        run: |
          echo "ğŸ”„ ä½¿ç”¨åˆå¹¶æ¨¡å¼åŒæ­¥..."
          git checkout main
          
          # ä¿å­˜æœ¬åœ°æ›´æ”¹ï¼ˆå¦‚æœæœ‰ï¼‰
          if ! git diff --quiet; then
            echo "ğŸ’¾ ä¿å­˜æœ¬åœ°æ›´æ”¹..."
            git stash push -m "auto-stash-$(date +%Y%m%d)"
          fi
          
          # åˆå¹¶ä¸Šæ¸¸æ›´æ–°
          if git merge upstream/main --no-edit; then
            echo "âœ… åˆå¹¶æˆåŠŸ"
          else
            echo "âŒ åˆå¹¶å†²çªï¼Œå°è¯•è‡ªåŠ¨è§£å†³..."
            
            # ä¼˜å…ˆä½¿ç”¨ä¸Šæ¸¸ç‰ˆæœ¬è§£å†³å†²çª
            git checkout --theirs .
            git add .
            git commit -m "Merge upstream and resolve conflicts (auto)"
            
            echo "âš ï¸ æ³¨æ„ï¼šè‡ªåŠ¨è§£å†³äº†å†²çªï¼Œå»ºè®®æ£€æŸ¥åç¡®è®¤"
          fi

      - name: Sync upstream (reset mode)
        if: inputs.sync_mode == 'reset' && steps.check.outputs.has_updates == 'true'
        run: |
          echo "ğŸ”„ ä½¿ç”¨é‡ç½®æ¨¡å¼åŒæ­¥..."
          echo "âš ï¸ è­¦å‘Šï¼šè¿™å°†ä¸¢å¼ƒæ‰€æœ‰æœ¬åœ°æ›´æ”¹ï¼"
          
          git checkout main
          git reset --hard upstream/main
          
          echo "âœ… å·²é‡ç½®åˆ°ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬"

      - name: Push to origin
        if: steps.check.outputs.has_updates == 'true'
        run: |
          echo "ğŸš€ æ¨é€åˆ° origin..."
          git push origin main --force
          echo "âœ… æ¨é€æˆåŠŸ"

      - name: Upload backup artifact
        if: inputs.backup_database && steps.check.outputs.has_updates == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ github.run_id }}
          path: backups/*.sql
          retention-days: 30

      - name: Trigger deployment
        if: inputs.deploy_after_sync && steps.check.outputs.has_updates == 'true'
        run: |
          echo "âœ… ä»£ç å·²æ¨é€ï¼ŒBuild workflow å°†è‡ªåŠ¨è§¦å‘éƒ¨ç½²"
          echo ""
          echo "æŸ¥çœ‹éƒ¨ç½²è¿›åº¦:"
          echo "https://github.com/${{ github.repository }}/actions"

      - name: Summary
        if: steps.check.outputs.has_updates == 'true'
        run: |
          echo ""
          echo "============================================"
          echo "  åŒæ­¥å®Œæˆï¼"
          echo "============================================"
          echo ""
          echo "ğŸ“Š æ›´æ–°å†…å®¹:"
          git log --oneline -10
          echo ""
          echo "ğŸŒ ä½ çš„æœåŠ¡: https://pw.pxlx.xyz"
          echo "ğŸ“ˆ éƒ¨ç½²çŠ¶æ€: https://github.com/${{ github.repository }}/actions"

      - name: No updates
        if: steps.check.outputs.has_updates == 'false'
        run: |
          echo ""
          echo "============================================"
          echo "  æ— éœ€æ›´æ–°"
          echo "============================================"
          echo ""
          echo "ä½ çš„ä»“åº“å·²ç»æ˜¯æœ€æ–°ç‰ˆæœ¬ã€‚"
